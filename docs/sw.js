const CACHE_NAME="storyapp-v1",API_URL="https://story-api.dicoding.dev/v1/stories",urlsToCache=["/","/index.html","/app.bundle.js","/manifest.json","/favicon.png","/images/logo.png"];let lastNotificationId=null;self.addEventListener("install",(e=>{console.log("Service Worker: Installing..."),e.waitUntil(caches.open(CACHE_NAME).then((e=>(console.log("Service Worker: Caching App Shell assets"),Promise.all(urlsToCache.map((t=>e.add(t).catch((e=>{console.warn("Gagal cache:",t,e)})))))))))})),self.addEventListener("activate",(e=>{console.log("Service Worker: Activating..."),e.waitUntil(caches.keys().then((e=>Promise.all(e.map((e=>{if(e!==CACHE_NAME)return console.log("Service Worker: Deleting old cache:",e),caches.delete(e)}))))))})),self.addEventListener("fetch",(e=>{const{request:t}=e;t.url.startsWith(API_URL)?e.respondWith(fetch(t).catch((()=>new Response(JSON.stringify({stories:[],error:"offline"}),{headers:{"Content-Type":"application/json"}})))):e.respondWith(caches.match(t).then((e=>e||fetch(t))))})),self.addEventListener("push",(e=>{const t=e.data?.json()||{},i=t.title||"Pesan Baru Story App",n={body:t.message||"Anda punya notifikasi baru dari Story App.",icon:"/images/logo.png",data:{url:t.url||"#/home",id:t.id||Date.now()}};n.data.id!==lastNotificationId?(lastNotificationId=n.data.id,e.waitUntil(self.registration.showNotification(i,n))):console.log("Notifikasi sudah ditampilkan, skip.")})),self.addEventListener("notificationclick",(e=>{e.notification.close();const t=e.notification.data.url;e.waitUntil(clients.matchAll({type:"window",includeUncontrolled:!0}).then((e=>{for(const i of e)if(i.url===t&&"focus"in i)return i.focus();if(clients.openWindow)return clients.openWindow(t)})))}));